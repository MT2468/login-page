<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTube</title>
  <meta name="description" content="MTube: vídeos, clips e upload com experiência inspirada no YouTube.">
  <meta name="theme-color" content="#0f172a">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --surface: #111827;
      --surface-2: #1f2937;
      --text: #e5e7eb;
      --muted: #cbd5e1;
      --accent: #3b82f6;
      --accent-strong: #2563eb;
      --danger: #ef4444;
      --success: #22c55e;
      --card: #0b1220;
      --radius: 12px;
      --shadow: 0 18px 40px rgba(0,0,0,0.32);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.18), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(16,185,129,0.12), transparent 30%),
                  #0b1220;
      color: var(--text);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    button { font-family: inherit; }
    .hidden { display: none !important; }
    .app-shell {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background: rgba(17,24,39,0.8);
      border-right: 1px solid rgba(255,255,255,0.05);
      padding: 20px 18px;
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      height: 100vh;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: -0.4px;
      font-size: 18px;
      margin-bottom: 24px;
    }
    .logo-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(120deg, #3b82f6, #a855f7);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800;
    }
    .nav-group { margin-bottom: 26px; }
    .nav-label { text-transform: uppercase; font-size: 12px; color: var(--muted); margin-bottom: 10px; letter-spacing: 0.6px; }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--text);
      transition: background 0.2s ease, transform 0.1s ease;
    }
    .nav-item:hover { background: rgba(255,255,255,0.06); }
    .nav-item.active { background: rgba(59,130,246,0.18); color: #dbeafe; }
    header.topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(11,18,32,0.92);
      border-bottom: 1px solid rgba(255,255,255,0.04);
      padding: 12px 20px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: center;
      backdrop-filter: blur(12px);
    }
    .search-box {
      display: grid;
      grid-template-columns: 1fr auto;
      background: rgba(255,255,255,0.05);
      border-radius: 999px;
      padding: 6px;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .search-box input {
      background: transparent;
      border: none;
      color: var(--text);
      padding: 8px 12px;
      outline: none;
      font-size: 14px;
    }
    .pill-btn {
      border: none;
      background: rgba(59,130,246,0.18);
      color: #dbeafe;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, background 0.2s ease;
    }
    .pill-btn:hover { background: rgba(59,130,246,0.28); }
    .pill-btn:active { transform: translateY(1px); }
    main.content { padding: 20px; }
    .hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .hero-card {
      padding: 16px;
      background: linear-gradient(130deg, rgba(59,130,246,0.12), rgba(168,85,247,0.08));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .hero-card h2 { margin: 0 0 8px; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin: 6px 0 14px; }
    .filter-pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--muted);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .filter-pill.active { background: rgba(59,130,246,0.18); color: #e5edff; border-color: rgba(59,130,246,0.5); }
    .filter-controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 4px 0 14px; }
    .filter-controls .field { margin: 0; width: 220px; }
    .pagination-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 12px 0 6px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.02);
    }
    .pagination-actions { display: flex; gap: 8px; align-items: center; }
    .pagination-info { color: var(--muted); font-size: 14px; }
    .skeleton { position: relative; overflow: hidden; background: rgba(255,255,255,0.04); }
    .skeleton::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
      animation: shimmer 1.3s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .skeleton-thumb { width: 100%; aspect-ratio: 16/9; border-radius: 10px; }
    .skeleton-line { height: 10px; border-radius: 6px; margin-top: 8px; }
    .search-results-box {
      background: rgba(17,24,39,0.7);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0 14px;
    }
    .search-results-head { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: center; }
    .search-results-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .search-results-list { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .search-chip { border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 6px 10px; background: rgba(255,255,255,0.04); cursor: pointer; }
    .search-chip.active { background: rgba(59,130,246,0.18); border-color: rgba(59,130,246,0.5); }
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .video-card {
      background: rgba(17,24,39,0.8);
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .video-card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.35); }
    .thumb { position: relative; aspect-ratio: 16 / 9; background: #0f172a; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .thumb .badge { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.65); padding: 4px 8px; border-radius: 8px; font-size: 12px; }
    .card-body { padding: 12px; display: grid; grid-template-columns: auto 1fr; gap: 10px; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(120deg,#3b82f6,#a855f7); display:grid; place-items:center; font-weight:700; color:#fff; }
    .card-text h4 { margin: 0; font-size: 15px; }
    .card-text p { margin: 4px 0 0; color: var(--muted); font-size: 13px; }
    .section-title { margin: 16px 0 10px; font-weight: 700; letter-spacing: -0.2px; }
    .recommendations, .tracks-row { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 6px; scrollbar-width: thin; }
    .recommendations::-webkit-scrollbar, .tracks-row::-webkit-scrollbar { height: 8px; }
    .recommendations::-webkit-scrollbar-thumb, .tracks-row::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 999px; }
    .track-card { min-width: 240px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 12px; cursor: pointer; transition: transform 0.15s ease, background 0.2s ease; }
    .track-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.06); }
    .track-card h4 { margin: 0 0 6px; }
    .track-meta { display: flex; gap: 8px; align-items: center; color: var(--muted); font-size: 13px; }
    /* Watch page */
    .watch-page { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 10px; }
    .player {
      background: #0f172a;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px;
    }
    .player .player-frame { position: relative; aspect-ratio: 16 / 9; border-radius: 12px; overflow: hidden; background: #0b1220; display:grid; place-items:center; color: var(--muted); }
    .player .bar { position: absolute; bottom: 0; left: 0; height: 5px; background: #ef4444; width: 100%; }
    .player-status { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 6px 10px; border-radius: 8px; font-size: 13px; color: #e5e7eb; }
    .watch-meta { margin-top: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
    .chip { padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); cursor: pointer; background: rgba(255,255,255,0.05); }
    .chip.active { background: rgba(59,130,246,0.18); border-color: rgba(59,130,246,0.6); }
    .chapters { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; margin-top: 12px; background: var(--card-bg); }
    .chapters h4 { margin: 0 0 8px; }
    .chapters p { margin: 0 0 12px; color: var(--muted); }
    .chapters-list { display: flex; flex-direction: column; gap: 8px; }
    .chapter-link { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); cursor: pointer; text-align: left; color: var(--text); }
    .chapter-time { font-weight: 700; color: #93c5fd; }
    .transcript-box { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; margin-top: 12px; background: var(--card-bg); display: flex; flex-direction: column; gap: 10px; }
    .transcript-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .transcript-head h4 { margin: 0; }
    .transcript-head p { margin: 0; color: var(--muted); }
    .transcript-search { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.06); color: var(--text); min-width: 200px; }
    .transcript-list { display: flex; flex-direction: column; gap: 8px; max-height: 260px; overflow: auto; }
    .transcript-item { border: 1px solid rgba(255,255,255,0.08); padding: 8px 10px; border-radius: 10px; display: grid; grid-template-columns: auto 1fr; gap: 8px; cursor: pointer; }
    .transcript-item.active { border-color: #3b82f6; background: rgba(59,130,246,0.08); }
    .transcript-item .timestamp { font-weight: 700; color: #93c5fd; }
    .suggestions { display: grid; gap: 12px; }
    .comments-box { margin-top: 18px; background: rgba(17,24,39,0.85); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; }
    .comments-box h4 { margin: 0 0 10px; }
    .comment-form { display: grid; gap: 10px; margin-bottom: 12px; }
    .comment-form textarea { width: 100%; min-height: 80px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--text); padding: 10px; resize: vertical; }
    .comment-form button { justify-self: flex-end; }
    .comment-list { display: grid; gap: 10px; }
    .comment-item { border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 10px; background: rgba(255,255,255,0.02); }
    .comment-head { display: flex; justify-content: space-between; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); }
    .comment-actions { display: flex; gap: 8px; margin-top: 8px; }
    .comment-actions button { border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--text); padding: 6px 10px; cursor: pointer; font-size: 12px; }
    .comment-actions button.active { background: rgba(59,130,246,0.18); border-color: rgba(59,130,246,0.5); }
    /* Forms */
    .auth-wrapper { min-height: 100vh; display: grid; place-items: center; padding: 20px; }
    .panel { width: 100%; max-width: 420px; background: rgba(17,24,39,0.9); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); }
    .panel h1 { margin: 0 0 6px; }
    .panel p { margin: 0 0 16px; color: var(--muted); }
    .field { display: grid; gap: 6px; margin-bottom: 12px; }
    .field label { font-size: 14px; color: var(--muted); }
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      color: var(--text);
    }
    .btn { border: none; padding: 12px 14px; border-radius: 12px; cursor: pointer; font-weight: 700; }
    .btn.primary { background: linear-gradient(120deg, #2563eb, #3b82f6); color: #fff; width: 100%; }
    .btn.secondary { background: rgba(255,255,255,0.06); color: var(--text); }
    .link { color: #93c5fd; cursor: pointer; }
    .toast { position: fixed; bottom: 18px; right: 18px; background: #111827; border: 1px solid rgba(255,255,255,0.08); padding: 12px 14px; border-radius: 12px; box-shadow: var(--shadow); display: none; }
    /* Upload modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 20; }
    .modal { background: rgba(17,24,39,0.95); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 18px; width: min(640px, 92vw); box-shadow: var(--shadow); }
    .thumb-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap: 10px; margin-top: 8px; }
    .thumb-option { border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; cursor: pointer; position: relative; }
    .thumb-option img { width: 100%; display: block; height: 80px; object-fit: cover; }
    .thumb-option input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .tag { display: inline-block; padding: 4px 8px; border-radius: 10px; background: rgba(255,255,255,0.06); font-size: 12px; margin-left: 6px; }
    @media (max-width: 900px) {
      .app-shell { grid-template-columns: 1fr; }
      .sidebar { height: auto; position: relative; }
      .watch-page { grid-template-columns: 1fr; }
      .transcript-list { max-height: 200px; }
      .transcript-head { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div class="auth-wrapper" id="login-view">
    <div class="panel">
      <h1>Entrar no MTube</h1>
      <p>Acesse sua conta para publicar, assistir e salvar clipes.</p>
      <form id="login-form">
        <div class="field">
          <label for="login-username">Usuário</label>
          <input id="login-username" name="username" required>
        </div>
        <div class="field">
          <label for="login-password">Senha</label>
          <input id="login-password" name="password" type="password" required>
        </div>
        <div class="field" style="display:flex;align-items:center;gap:8px;">
          <input id="remember" type="checkbox">
          <label for="remember">Lembre-se de mim</label>
        </div>
        <button class="btn primary" type="submit">Entrar</button>
      </form>
      <p>Não tem conta? <span class="link" id="go-signup">Criar conta</span></p>
    </div>
  </div>
  <div class="auth-wrapper hidden" id="signup-view">
    <div class="panel">
      <h1>Criar conta</h1>
      <p>Cadastre-se para começar a enviar seus vídeos.</p>
      <form id="signup-form">
        <div class="field">
          <label for="signup-username">Usuário</label>
          <input id="signup-username" name="username" required>
        </div>
        <div class="field">
          <label for="signup-password">Senha</label>
          <input id="signup-password" name="password" type="password" minlength="4" required>
        </div>
        <div class="field">
          <label for="signup-display">Nome público</label>
          <input id="signup-display" name="display" required>
        </div>
        <button class="btn primary" type="submit">Cadastrar</button>
      </form>
      <p>Já tem conta? <span class="link" id="back-login">Voltar</span></p>
    </div>
  </div>
  <div class="app-shell hidden" id="app">
    <aside class="sidebar">
      <div class="logo"><div class="logo-circle">M</div><span>MTube</span></div>
      <div class="nav-group">
        <div class="nav-label">Principal</div>
        <div class="nav-item active" data-view="home">Início</div>
        <div class="nav-item" data-view="clips">Clipes</div>
        <div class="nav-item" data-view="upload">Enviar vídeo</div>
      </div>
      <div class="nav-group">
        <div class="nav-label">Conta</div>
        <div class="nav-item" id="nav-logout">Sair</div>
      </div>
    </aside>
    <div>
      <header class="topbar">
        <div class="search-box">
          <input id="search" placeholder="Buscar vídeos">
          <button class="pill-btn" id="search-btn">Buscar</button>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="pill-btn" id="open-upload">Criar</button>
          <div id="user-chip" class="chip">Entrou como <strong id="user-name">usuário</strong></div>
        </div>
      </header>
      <main class="content">
        <section id="home-view">
          <div class="hero">
            <div class="hero-card">
              <h2>Descubra e publique</h2>
              <p>Home inspirada no YouTube, com feed personalizado e navegação rápida.</p>
              <button class="pill-btn" id="from-hero-upload">Publicar agora</button>
            </div>
            <div class="hero-card">
              <h2>Clipes offline</h2>
              <p>Salve momentos curtos para assistir sem internet.</p>
              <span class="tag">Beta</span>
            </div>
            <div class="hero-card">
              <h2>Notificações inteligentes</h2>
              <p>Receba alertas de canais e categorias que você segue.</p>
            </div>
          </div>
          <div id="categories" class="filters hidden"></div>
          <div class="filters">
            <div class="filter-pill active" data-filter="all">Todos</div>
            <div class="filter-pill" data-filter="Entretenimento">Entretenimento</div>
            <div class="filter-pill" data-filter="Filmes & TV">Filmes & TV</div>
            <div class="filter-pill" data-filter="Games">Games</div>
            <div class="filter-pill" data-filter="Música">Música</div>
            <div class="filter-pill" data-filter="Esportes">Esportes</div>
          </div>
          <div class="filter-controls">
            <div class="field">
              <label for="order-select">Ordenação</label>
              <select id="order-select">
                <option value="recentes">Mais recentes</option>
                <option value="views">Mais vistos</option>
                <option value="avaliados">Melhor avaliados</option>
              </select>
            </div>
            <div class="field">
              <label for="duration-select">Duração</label>
              <select id="duration-select">
                <option value="todas">Todas</option>
                <option value="curtas">Até 4 min</option>
                <option value="medias">5 a 10 min</option>
                <option value="longas">Acima de 10 min</option>
              </select>
            </div>
          </div>
          <div id="search-results-box" class="search-results-box hidden">
            <div class="search-results-head">
              <div>
                <strong id="search-summary"></strong>
                <p id="search-detail" style="color:var(--muted);margin:4px 0 0;"></p>
              </div>
              <div class="search-results-actions">
                <button class="pill-btn secondary" id="prev-result" type="button">Anterior</button>
                <button class="pill-btn secondary" id="next-result" type="button">Próximo</button>
                <button class="pill-btn" id="open-current" type="button">Abrir</button>
                <button class="pill-btn secondary" id="clear-search" type="button">Limpar</button>
              </div>
            </div>
            <div id="search-results-list" class="search-results-list"></div>
          </div>
          <div id="recommend-box" class="hidden">
            <h3 class="section-title">Recomendados para você</h3>
            <div class="recommendations" id="recommendations"></div>
          </div>
          <div id="tracks-box" class="hidden">
            <h3 class="section-title">Trilhas temáticas</h3>
            <div class="tracks-row" id="tracks-row"></div>
          </div>
          <h3 class="section-title">Vídeos</h3>
          <div class="pagination-box" id="grid-pagination" aria-live="polite">
            <div class="pagination-info" id="grid-summary">Carregando...</div>
            <div class="pagination-actions">
              <button class="pill-btn secondary" id="grid-prev" type="button">Anterior</button>
              <button class="pill-btn secondary" id="grid-next" type="button">Próximo</button>
            </div>
          </div>
          <div class="grid" id="video-grid"></div>
        </section>
        <section id="watch-view" class="hidden">
          <div class="watch-page">
            <div>
              <div class="player">
                <div class="player-frame" id="player-frame">
                  <div id="player-thumb"></div>
                  <div style="position:absolute;inset:0;display:grid;place-items:center;">
                    <div style="background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:10px;">O vídeo não está disponível por limitações do site.</div>
                  </div>
                  <div class="player-status" id="player-status">Pausado · 0:00</div>
                  <div class="bar" id="player-progress"></div>
                </div>
                <div class="watch-meta">
                  <h2 id="watch-title"></h2>
                  <p id="watch-stats" style="color:var(--muted);"></p>
                  <div class="actions" style="flex-wrap:wrap;gap:8px;">
                    <div class="chip" id="action-like">Curtir (<span id="like-count">0</span>)</div>
                    <div class="chip" id="action-dislike">Não curtir (<span id="dislike-count">0</span>)</div>
                    <div class="chip" id="action-subscribe">Inscrever-se</div>
                    <div class="chip" id="action-watchlater">Assistir depois</div>
                    <div class="chip" id="action-offline">Salvar offline</div>
                    <div class="chip" id="action-playlist">Adicionar à playlist</div>
                    <div class="chip" id="action-history">Salvar histórico</div>
                  </div>
                  <div class="chapters">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                      <div>
                        <h4 style="margin:0;">Capítulos</h4>
                        <p id="chapters-summary">Gerado a partir da descrição.</p>
                      </div>
                    </div>
                    <div class="chapters-list" id="chapters-list"></div>
                  </div>
                  <div class="transcript-box">
                    <div class="transcript-head">
                      <div>
                        <h4>Transcrição</h4>
                        <p id="transcript-summary">Linhas sincronizadas.</p>
                      </div>
                      <input id="transcript-search" class="transcript-search" placeholder="Buscar na transcrição" aria-label="Buscar na transcrição">
                    </div>
                    <div class="transcript-list" id="transcript-list"></div>
                  </div>
                  <div id="watch-desc" style="color:var(--muted);"></div>
                  <div class="comments-box">
                    <h4>Comentários</h4>
                    <form id="comment-form" class="comment-form">
                      <label for="comment-text" style="color:var(--muted);">Compartilhe sua opinião</label>
                      <textarea id="comment-text" placeholder="Escreva um comentário" required></textarea>
                      <button class="pill-btn" type="submit">Publicar comentário</button>
                    </form>
                    <div id="comments-list" class="comment-list"></div>
                  </div>
                </div>
              </div>
            </div>
            <aside>
              <h4>Sugeridos</h4>
              <div class="suggestions" id="suggestions"></div>
            </aside>
          </div>
        </section>
        <section id="clips-view" class="hidden">
          <div class="section-title" style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <h3 style="margin:0;">Clipes</h3>
              <div class="chip" id="tab-clips" aria-pressed="true">Clipes</div>
              <div class="chip" id="tab-watchlater" aria-pressed="false">Assistir depois</div>
              <div class="chip" id="tab-playlists" aria-pressed="false">Playlists</div>
              <div class="chip" id="tab-history" aria-pressed="false">Histórico</div>
            </div>
            <div id="watchlater-filters" class="hidden" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <label for="wl-category" style="color:var(--muted);font-size:13px;">Categoria</label>
              <select id="wl-category" style="padding:6px 8px;border-radius:8px;border:1px solid #2a2a2a;background:var(--card-bg);color:#fff;">
                <option value="all">Todas</option>
                <option value="Entretenimento">Entretenimento</option>
                <option value="Filmes & TV">Filmes & TV</option>
                <option value="Games">Games</option>
                <option value="Música">Música</option>
                <option value="Esportes">Esportes</option>
              </select>
              <label for="wl-order" style="color:var(--muted);font-size:13px;">Ordenar</label>
              <select id="wl-order" style="padding:6px 8px;border-radius:8px;border:1px solid #2a2a2a;background:var(--card-bg);color:#fff;">
                <option value="recentes">Mais recentes</option>
                <option value="views">Mais vistos</option>
                <option value="avaliados">Melhor avaliados</option>
              </select>
            </div>
          </div>
          <div class="grid" id="clips-grid"></div>
          <div class="grid hidden" id="watchlater-grid"></div>
          <div class="grid hidden" id="playlist-grid"></div>
          <div class="grid hidden" id="history-grid"></div>
        </section>
      </main>
    </div>
  </div>
  <div class="modal-backdrop" id="upload-modal">
    <div class="modal">
      <h3>Enviar vídeo</h3>
      <form id="upload-form">
        <div class="field">
          <label for="video-title">Título</label>
          <input id="video-title" required>
        </div>
        <div class="field">
          <label for="video-desc">Descrição</label>
          <textarea id="video-desc" rows="3" required></textarea>
        </div>
        <div class="field">
          <label for="video-duration">Duração (min)</label>
          <input id="video-duration" type="number" min="1" value="3" required>
        </div>
        <div class="field">
          <label for="video-category">Categoria</label>
          <select id="video-category">
            <option>Entretenimento</option>
            <option>Filmes & TV</option>
            <option>Games</option>
            <option>Música</option>
            <option>Esportes</option>
          </select>
        </div>
        <div class="field">
          <label>Escolha uma thumbnail</label>
          <div class="thumb-gallery" id="thumb-gallery"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
          <button class="btn secondary" type="button" id="cancel-upload">Cancelar</button>
          <button class="btn primary" type="submit">Publicar</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Utilidades básicas
    const qs = (sel) => document.querySelector(sel);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));
    const debounce = (fn, delay = 250) => {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    };
    const toastEl = qs('#toast');
    const showToast = (msg) => {
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(() => toastEl.style.display = 'none', 2600);
    };

    const storage = {
      load(key, fallback) {
        try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
      },
      save(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    };

    const SHARED_KEY = 'mtube-shared';

    const COMMENT_KEY = 'mtube-comments';
    const WATCH_LATER_KEY = 'mtube-watch-later';
    const PLAYLIST_KEY = 'mtube-playlists';
    const HISTORY_KEY = 'mtube-history';
    const TRANSCRIPT_KEY = 'mtube-transcripts';
    const COMMENT_COOLDOWN_MS = 5000;
    const SESSION_TTL_MS = 1000 * 60 * 60 * 24 * 14; // 14 dias

    // Sync simples entre abas/dispositivos: usamos localStorage como “servidor” local
    function loadSharedStore() {
      return storage.load(SHARED_KEY, null);
    }

    function saveSharedStore(payload) {
      storage.save(SHARED_KEY, payload);
      if (window.BroadcastChannel) {
        sharedChannel?.postMessage({ type: 'sync', payload });
      }
    }

    function migrateLegacyStores() {
      const shared = loadSharedStore();
      const legacyUsers = storage.load('mtube-users', []);
      const legacyVideos = storage.load('mtube-videos', []);
      if (!shared && (legacyUsers.length || legacyVideos.length)) {
        const payload = { users: legacyUsers, videos: legacyVideos };
        saveSharedStore(payload);
        return payload;
      }
      return shared;
    }

    const sharedChannel = window.BroadcastChannel ? new BroadcastChannel('mtube-shared') : null;

    async function sha256(text) {
      const enc = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-256', enc);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const sharedInitial = migrateLegacyStores();
    const baseUsers = sharedInitial?.users ?? storage.load('mtube-users', []);
    const baseVideos = sharedInitial?.videos ?? storage.load('mtube-videos', []);

    // Estado
    const state = {
      user: null,
      users: baseUsers,
      session: storage.load('mtube-session', null),
      videos: baseVideos,
      clips: storage.load('mtube-clips', [
        { id: 'clip-1', title: 'Clip rápido', duration: '0:30', views: 1200, thumb: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=600&q=60' }
      ]),
      filter: { categoria: 'all', ordem: 'recentes', duracao: 'todas', afinidade: true },
      pagination: { page: 1, perPage: 12 },
      search: { termo: '', resultados: [], indice: 0 },
      afinidade: { categorias: {} },
      currentVideo: null,
      comments: storage.load(COMMENT_KEY, {}),
      watchLater: storage.load(WATCH_LATER_KEY, []),
      watchLaterFilter: { categoria: 'all', ordem: 'recentes' },
      playlists: storage.load(PLAYLIST_KEY, []),
      playlistsFilter: { categoria: 'all', ordem: 'recentes' },
      historico: storage.load(HISTORY_KEY, []),
      historicoFilter: { categoria: 'all', ordem: 'recentes' },
      transcripts: storage.load(TRANSCRIPT_KEY, {}),
      transcriptSearch: '',
      player: { duration: 0, position: 0, playing: false, volume: 0.8 },
    };

    const defaultThumbs = [
      'https://images.unsplash.com/photo-1525182008055-f88b95ff7980?auto=format&fit=crop&w=800&q=60',
      'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=800&q=60',
      'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?auto=format&fit=crop&w=800&q=60',
      'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=800&q=60'
    ];

    function getSharedPayload() {
      return { users: state.users, videos: state.videos };
    }

    function persistSharedState() {
      storage.save('mtube-users', state.users);
      storage.save('mtube-videos', state.videos);
      saveSharedStore(getSharedPayload());
    }

    function applySharedPayload(payload, { skipRender = false } = {}) {
      if (!payload) return;
      state.users = payload.users || [];
      state.videos = payload.videos || [];
      storage.save('mtube-users', state.users);
      storage.save('mtube-videos', state.videos);
      atualizarAfinidade();
      if (!skipRender) {
        renderGrid();
        renderClips();
        if (state.currentVideo) openWatch(state.currentVideo.id);
      }
    }

    function ensureSeedVideos() {
      const shared = loadSharedStore();
      if (shared?.videos?.length) {
        applySharedPayload(shared, { skipRender: true });
        return;
      }
      if (state.videos.length) {
        persistSharedState();
        return;
      }
      const now = Date.now();
      state.videos = [
        {
          id: 'v-1',
          title: 'Bem-vindo ao MTube',
          description: 'Apresentação rápida da nova experiência inspirada no YouTube.\n00:00 Introdução\n01:00 Navegação principal\n02:30 Upload guiado\n03:30 Encerramento',
          channel: 'Equipe MTube',
          category: 'Entretenimento',
          duration: 4,
          thumb: defaultThumbs[0],
          views: 1200,
          likes: 340,
          dislikes: 12,
          createdAt: now - 1000 * 60 * 60 * 3,
        },
        {
          id: 'v-2',
          title: 'Como publicar vídeos',
          description: 'Passo a passo do fluxo de upload e organização de categorias.\n00:00 Acesso ao upload\n01:10 Escolha de miniatura\n03:00 Publicação e feed',
          channel: 'Equipe MTube',
          category: 'Games',
          duration: 6,
          thumb: defaultThumbs[1],
          views: 980,
          likes: 280,
          dislikes: 6,
          createdAt: now - 1000 * 60 * 60 * 8,
        }
      ];
      persistSharedState();
    }

    function atualizarAfinidade() {
      const categorias = {};
      const acumular = (cat, peso = 1) => {
        if (!cat) return;
        categorias[cat] = (categorias[cat] || 0) + peso;
      };
      state.videos.forEach(v => acumular(v.category, Math.max(1, Math.min(5, (v.views || 0) / 500))));
      state.watchLater.forEach(id => {
        const v = state.videos.find(x => x.id === id);
        if (v) acumular(v.category, 4);
      });
      state.playlists.forEach(id => {
        const v = state.videos.find(x => x.id === id);
        if (v) acumular(v.category, 3);
      });
      state.historico.forEach(id => {
        const v = state.videos.find(x => x.id === id);
        if (v) acumular(v.category, 5);
      });
      state.clips.forEach(c => acumular(c.category, 2));
      state.afinidade.categorias = categorias;
    }

    function pontuarAfinidade(video) {
      return (state.afinidade.categorias?.[video.category] || 0);
    }

    // Renderização
    function minutesToDuration(min) {
      const m = Math.floor(min);
      const s = Math.round((min - m) * 60);
      return `${m}:${s.toString().padStart(2,'0')}`;
    }

    function timeAgo(ts) {
      const diff = Date.now() - ts;
      const hours = Math.floor(diff / 3.6e6);
      if (hours < 1) return 'agora mesmo';
      if (hours < 24) return `${hours}h atrás`;
      const days = Math.floor(hours / 24);
      return `${days}d atrás`;
    }

    function secondsToClock(sec) {
      const total = Math.max(0, Math.floor(sec));
      const h = Math.floor(total / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = total % 60;
      const base = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      return h > 0 ? `${h}:${base}` : base;
    }

    function parseTimecode(str) {
      if (!str) return null;
      const parts = str.split(':').map(Number);
      if (parts.some(isNaN)) return null;
      if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
      if (parts.length === 2) return parts[0] * 60 + parts[1];
      return null;
    }

    window.addEventListener('storage', (ev) => {
      if (ev.key !== SHARED_KEY || !ev.newValue) return;
      try {
        applySharedPayload(JSON.parse(ev.newValue));
      } catch (err) {
        console.warn('Falha ao sincronizar storage compartilhado', err);
      }
    });

    sharedChannel?.addEventListener('message', ({ data }) => {
      if (data?.type === 'sync') applySharedPayload(data.payload);
    });

    function escapeHTML(str = '') {
      return str.replace(/[&<>"']/g, (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch]));
    }

    function highlightTerm(text = '', term = '') {
      if (!term) return escapeHTML(text);
      const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${safeTerm})`, 'gi');
      return escapeHTML(text).replace(regex, '<mark>$1</mark>');
    }

    function parseChapters(description) {
      if (!description) return [];
      const lines = description.split(/\n|;/).map(l => l.trim()).filter(Boolean);
      const chapters = [];
      const regex = /(\d{1,2}:\d{2}(?::\d{2})?)\s+(.+)/;
      lines.forEach(line => {
        const match = line.match(regex);
        if (!match) return;
        const time = parseTimecode(match[1]);
        if (time === null) return;
        chapters.push({ time, label: match[2] });
      });
      return chapters.sort((a,b) => a.time - b.time);
    }

    function persistTranscripts() {
      storage.save(TRANSCRIPT_KEY, state.transcripts);
    }

    function getTranscript(video) {
      if (!video) return [];
      if (!state.transcripts[video.id]) {
        const sentences = video.description.split(/\.|\n|;/).map(t => t.trim()).filter(Boolean);
        const fallback = ['Introdução', 'Conteúdo principal', 'Resumo', 'Encerramento'];
        const totalSeconds = Math.max(60, Math.round((video.duration || 1) * 60));
        const baseList = sentences.length ? sentences : fallback;
        const step = Math.max(10, Math.floor(totalSeconds / Math.max(1, baseList.length)));
        let cursor = 0;
        state.transcripts[video.id] = baseList.map((text, idx) => {
          const item = { id: `t-${idx}`, time: Math.min(cursor, totalSeconds), text: text || `Seção ${idx + 1}` };
          cursor += step;
          return item;
        });
        state.transcripts[video.id].sort((a,b) => a.time - b.time);
        persistTranscripts();
      }
      return state.transcripts[video.id];
    }

    // Comentários
    const commentCooldown = {};

    function sanitizeText(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function persistComments() {
      storage.save(COMMENT_KEY, state.comments);
    }

    function getComments(videoId) {
      return state.comments[videoId] || [];
    }

    function renderComments(videoId) {
      const list = qs('#comments-list');
      const comments = getComments(videoId);
      if (!list) return;
      list.innerHTML = '';
      if (!comments.length) {
        list.innerHTML = '<p style="color: var(--muted);">Nenhum comentário ainda. Seja o primeiro!</p>';
        return;
      }
      comments.forEach(comment => {
        const ocultadoParaUsuario = state.user && comment.reportedBy?.includes(state.user.username);
        const wrap = document.createElement('div');
        const userReaction = state.user ? (comment.reactions?.[state.user.username] || null) : null;
        wrap.className = 'comment-item';

        if (ocultadoParaUsuario) {
          wrap.innerHTML = `
            <div class="comment-head">
              <strong>${comment.author}</strong>
              <span>Comentário ocultado após denúncia</span>
            </div>
          `;
          list.appendChild(wrap);
          return;
        }

        const head = document.createElement('div');
        head.className = 'comment-head';
        const authorEl = document.createElement('strong');
        authorEl.textContent = comment.author;
        const metaEl = document.createElement('span');
        const reports = comment.reportedBy?.length ? ` · ${comment.reportedBy.length} denúncia(s)` : '';
        metaEl.textContent = `${timeAgo(comment.createdAt)}${reports}`;
        head.append(authorEl, metaEl);

        const body = document.createElement('div');
        body.textContent = comment.text;

        const actions = document.createElement('div');
        actions.className = 'comment-actions';
        const likeBtn = document.createElement('button');
        likeBtn.dataset.commentAction = 'like';
        likeBtn.dataset.id = comment.id;
        likeBtn.className = userReaction === 'like' ? 'active' : '';
        likeBtn.textContent = `Curtir (${comment.likes || 0})`;

        const dislikeBtn = document.createElement('button');
        dislikeBtn.dataset.commentAction = 'dislike';
        dislikeBtn.dataset.id = comment.id;
        dislikeBtn.className = userReaction === 'dislike' ? 'active' : '';
        dislikeBtn.textContent = `Não curtir (${comment.dislikes || 0})`;

        const reportBtn = document.createElement('button');
        reportBtn.dataset.commentAction = 'report';
        reportBtn.dataset.id = comment.id;
        reportBtn.textContent = comment.reportedBy?.length ? `Denunciar (${comment.reportedBy.length})` : 'Denunciar';

        actions.append(likeBtn, dislikeBtn, reportBtn);

        wrap.append(head, body, actions);
        list.appendChild(wrap);
      });
    }

    async function addComment(videoId, text) {
      if (!state.user) {
        showToast('Faça login para comentar.');
        return;
      }
      const trimmed = text.trim();
      if (!trimmed) return showToast('Não é possível enviar um comentário vazio.');
      const now = Date.now();
      const ultimoEnvio = commentCooldown[state.user.username] || 0;
      if (now - ultimoEnvio < COMMENT_COOLDOWN_MS) {
        return showToast('Aguarde alguns segundos antes de comentar novamente.');
      }
      if (!state.comments[videoId]) state.comments[videoId] = [];
      const jaExiste = state.comments[videoId].some(c => c.username === state.user.username && (c.rawText || c.text)?.toLowerCase() === trimmed.toLowerCase());
      if (jaExiste) return showToast('Você já enviou esse comentário.');

      const safeText = sanitizeText(trimmed);
      const comment = {
        id: 'c-' + crypto.randomUUID(),
        author: state.user.display || state.user.username,
        username: state.user.username,
        text: safeText,
        rawText: trimmed,
        createdAt: Date.now(),
        likes: 0,
        dislikes: 0,
        reactions: {},
        reportedBy: [],
      };
      state.comments[videoId].unshift(comment);
      commentCooldown[state.user.username] = now;
      persistComments();
      renderComments(videoId);
      showToast('Comentário publicado.');
    }

    function reactToComment(commentId, action) {
      if (!state.user || !state.currentVideo) {
        showToast('Entre na sua conta para reagir.');
        return;
      }
      const comments = getComments(state.currentVideo.id);
      const comment = comments.find(c => c.id === commentId);
      if (!comment) return;
      comment.reactions = comment.reactions || {};
      const previous = comment.reactions[state.user.username];
      // Reverte reação anterior, se houver
      if (previous === 'like') comment.likes = Math.max(0, (comment.likes || 0) - 1);
      if (previous === 'dislike') comment.dislikes = Math.max(0, (comment.dislikes || 0) - 1);

      if (previous === action) {
        delete comment.reactions[state.user.username];
        persistComments();
        renderComments(state.currentVideo.id);
        return;
      }

      comment.reactions[state.user.username] = action;
      if (action === 'like') comment.likes = (comment.likes || 0) + 1;
      if (action === 'dislike') comment.dislikes = (comment.dislikes || 0) + 1;
      persistComments();
      renderComments(state.currentVideo.id);
    }

    function reportComment(commentId) {
      if (!state.user || !state.currentVideo) {
        showToast('Entre na sua conta para denunciar.');
        return;
      }
      const comments = getComments(state.currentVideo.id);
      const comment = comments.find(c => c.id === commentId);
      if (!comment) return;
      comment.reportedBy = comment.reportedBy || [];
      if (comment.reportedBy.includes(state.user.username)) {
        showToast('Você já denunciou este comentário.');
        return;
      }
      comment.reportedBy.push(state.user.username);
      persistComments();
      renderComments(state.currentVideo.id);
      showToast('Comentário denunciado e ocultado localmente.');
    }

    // Capítulos e transcrição
    function renderChapters(video) {
      const list = qs('#chapters-list');
      const summary = qs('#chapters-summary');
      if (!list || !summary) return;
      list.innerHTML = '';
      const chapters = parseChapters(video.description);
      if (!chapters.length) {
        summary.textContent = 'Sem marcadores na descrição deste vídeo.';
        list.innerHTML = '<p style="color: var(--muted);">Adicione timestamps como "00:00 Intro" na descrição para gerar capítulos.</p>';
        return;
      }
      summary.textContent = `${chapters.length} capítulo(s) a partir da descrição.`;
      chapters.forEach(ch => {
        const btn = document.createElement('button');
        btn.className = 'chapter-link';
        btn.innerHTML = `<span class="chapter-time">${secondsToClock(ch.time)}</span><span>${ch.label}</span>`;
        btn.addEventListener('click', () => setPlayerPosition(ch.time, true));
        list.appendChild(btn);
      });
    }

    function highlightTranscriptByTime(time) {
      const list = qs('#transcript-list');
      if (!list) return;
      const items = Array.from(list.querySelectorAll('.transcript-item'));
      if (!items.length) return;
      let active = items[0];
      items.forEach(item => {
        const itemTime = Number(item.dataset.time || 0);
        if (itemTime <= time) active = item;
      });
      items.forEach(i => i.classList.remove('active'));
      active?.classList.add('active');
      active?.scrollIntoView({ block: 'nearest' });
    }

    function renderTranscript(video) {
      const list = qs('#transcript-list');
      const summary = qs('#transcript-summary');
      const searchInput = qs('#transcript-search');
      if (!list || !summary) return;
      const transcript = getTranscript(video);
      const termo = (state.transcriptSearch || '').toLowerCase();
      const filtrado = termo ? transcript.filter(line => line.text.toLowerCase().includes(termo)) : transcript;
      summary.textContent = termo
        ? `${filtrado.length} de ${transcript.length} trechos para "${state.transcriptSearch}"`
        : `${transcript.length} linha(s) sincronizadas.`;
      list.innerHTML = '';
      if (!filtrado.length) {
        list.innerHTML = '<p style="color: var(--muted);">Nenhum trecho encontrado para este termo.</p>';
        return;
      }
      filtrado.forEach(line => {
        const item = document.createElement('div');
        item.className = 'transcript-item';
        item.dataset.time = String(line.time);
        item.id = `trans-${line.id}`;
        const timeEl = document.createElement('span');
        timeEl.className = 'timestamp';
        timeEl.textContent = secondsToClock(line.time);
        const textEl = document.createElement('div');
        textEl.textContent = line.text;
        item.append(timeEl, textEl);
        item.addEventListener('click', () => setPlayerPosition(line.time, true));
        list.appendChild(item);
      });
      if (searchInput && !searchInput.value && termo) {
        searchInput.value = state.transcriptSearch;
      }
      highlightTranscriptByTime(state.player.position || 0);
    }

    function setPlayerPosition(seconds, sincronizarTranscricao = false) {
      const duration = Math.max(1, Math.round((state.currentVideo?.duration || 1) * 60));
      state.player.duration = duration;
      state.player.position = Math.min(Math.max(0, seconds), duration);
      syncPlayerStatus();
      if (sincronizarTranscricao) highlightTranscriptByTime(state.player.position);
    }

    function syncPlayerStatus() {
      const bar = qs('#player-progress');
      const status = qs('#player-status');
      const duration = Math.max(1, state.player.duration || Math.round((state.currentVideo?.duration || 1) * 60));
      const pos = Math.min(Math.max(0, state.player.position || 0), duration);
      if (bar) bar.style.width = `${Math.min(100, (pos / duration) * 100)}%`;
      if (status) status.textContent = `${state.player.playing ? 'Reproduzindo' : 'Pausado'} · ${secondsToClock(pos)} / ${secondsToClock(duration)} · Vol ${Math.round((state.player.volume || 0) * 100)}%`;
    }

    function togglePlayback() {
      state.player.playing = !state.player.playing;
      syncPlayerStatus();
    }

    function adjustPosition(delta) {
      setPlayerPosition((state.player.position || 0) + delta, true);
    }

    function adjustVolume(delta) {
      state.player.volume = Math.min(1, Math.max(0, (state.player.volume || 0) + delta));
      syncPlayerStatus();
    }

    let shortcutsBound = false;
    function bindPlayerShortcuts() {
      if (shortcutsBound) return;
      document.addEventListener('keydown', handlePlayerShortcuts);
      shortcutsBound = true;
    }

    function unbindPlayerShortcuts() {
      if (!shortcutsBound) return;
      document.removeEventListener('keydown', handlePlayerShortcuts);
      shortcutsBound = false;
    }

    function handlePlayerShortcuts(ev) {
      if (qs('#watch-view').classList.contains('hidden')) return;
      if (!state.currentVideo) return;
      const tag = ev.target.tagName;
      if (['INPUT','TEXTAREA','SELECT','BUTTON'].includes(tag)) return;
      const key = ev.key.toLowerCase();
      if ([' ', 'k'].includes(key)) { ev.preventDefault(); togglePlayback(); return; }
      if (key === 'j' || ev.key === 'ArrowLeft') { ev.preventDefault(); adjustPosition(-10); return; }
      if (key === 'l' || ev.key === 'ArrowRight') { ev.preventDefault(); adjustPosition(10); return; }
      if (ev.key === 'ArrowUp') { ev.preventDefault(); adjustVolume(0.05); return; }
      if (ev.key === 'ArrowDown') { ev.preventDefault(); adjustVolume(-0.05); return; }
    }

    // Assistir depois e offline
    function persistWatchLater() {
      storage.save(WATCH_LATER_KEY, state.watchLater);
    }

    function persistPlaylists() {
      storage.save(PLAYLIST_KEY, state.playlists);
    }

    function persistHistorico() {
      storage.save(HISTORY_KEY, state.historico);
    }

    function toggleWatchLater(videoId) {
      if (!videoId) return;
      const idx = state.watchLater.indexOf(videoId);
      if (idx >= 0) {
        state.watchLater.splice(idx, 1);
        showToast('Removido de Assistir depois.');
      } else {
        state.watchLater.unshift(videoId);
        showToast('Adicionado em Assistir depois.');
      }
      persistWatchLater();
      atualizarAfinidade();
      renderGrid();
      renderWatchLater();
      atualizarEstadoWatchButtons(videoId);
    }

    function addToPlaylist(videoId, comToast = true) {
      if (!videoId) return;
      const exists = state.playlists.includes(videoId);
      if (!exists) {
        state.playlists.unshift(videoId);
        persistPlaylists();
        if (comToast) showToast('Adicionado à playlist.');
      } else if (comToast) {
        showToast('Esse vídeo já está na playlist.');
      }
      atualizarAfinidade();
      renderPlaylists();
      atualizarEstadoWatchButtons(videoId);
    }

    function removeFromPlaylist(videoId) {
      const idx = state.playlists.indexOf(videoId);
      if (idx >= 0) {
        state.playlists.splice(idx, 1);
        persistPlaylists();
        atualizarAfinidade();
        renderPlaylists();
        atualizarEstadoWatchButtons(videoId);
      }
    }

    function addToHistory(videoId, silencioso = true) {
      if (!videoId) return;
      state.historico = state.historico.filter(id => id !== videoId);
      state.historico.unshift(videoId);
      state.historico = state.historico.slice(0, 200);
      persistHistorico();
      atualizarAfinidade();
      renderHistorico();
      renderRecommendations();
      renderTracks();
      if (!silencioso) showToast('Adicionado ao histórico.');
    }

    function saveOffline(videoId) {
      const video = state.videos.find(v => v.id === videoId);
      if (!video) return showToast('Vídeo não encontrado.');
      const existing = state.clips.find(c => c.offlineFrom === videoId || c.id === `offline-${videoId}`);
      if (existing) return showToast('Já salvo para offline.');
      const clip = {
        id: `offline-${videoId}`,
        offlineFrom: videoId,
        title: video.title,
        duration: minutesToDuration(video.duration),
        views: video.views,
        thumb: video.thumb,
        status: 'baixando',
        category: video.category,
      };
      state.clips.unshift(clip);
      storage.save('mtube-clips', state.clips);
      atualizarAfinidade();
      renderClips();
      showToast('Salvando offline...');
      setTimeout(() => {
        clip.status = 'baixado';
        storage.save('mtube-clips', state.clips);
        atualizarAfinidade();
        renderClips();
        showToast('Vídeo disponível offline.');
      }, 400);
    }

    function resetPagination() {
      state.pagination.page = 1;
    }

    function renderGridSkeleton() {
      const grid = qs('#video-grid');
      if (!grid) return;
      grid.innerHTML = '';
      for (let i = 0; i < state.pagination.perPage; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'video-card skeleton';
        skeleton.innerHTML = `
          <div class="thumb skeleton-thumb"></div>
          <div class="card-body">
            <div class="avatar skeleton-line" style="width:36px;height:36px;border-radius:50%;margin-right:8px;"></div>
            <div class="card-text">
              <div class="skeleton-line" style="width:80%;"></div>
              <div class="skeleton-line" style="width:60%;"></div>
            </div>
          </div>
        `;
        grid.appendChild(skeleton);
      }
    }

    function renderRecommendations() {
      const box = qs('#recommend-box');
      const list = qs('#recommendations');
      if (!box || !list) return;
      if (state.search.termo) { box.classList.add('hidden'); return; }
      const candidatos = aplicarFiltros(state.videos, { searchTerm: '' }).slice(0, 6);
      if (!candidatos.length) { box.classList.add('hidden'); return; }
      box.classList.remove('hidden');
      list.innerHTML = '';
      candidatos.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.style.minWidth = '240px';
        card.innerHTML = `
          <div class="thumb" style="aspect-ratio:16/9;">
            <img src="${video.thumb}" alt="Thumbnail" loading="lazy" decoding="async">
            <div class="badge">${minutesToDuration(video.duration)}</div>
          </div>
          <div class="card-body">
            <div class="avatar">${video.channel.charAt(0).toUpperCase()}</div>
            <div class="card-text">
              <h4>${escapeHTML(video.title)}</h4>
              <p>${escapeHTML(video.channel)} · ${video.views} visualizações</p>
            </div>
          </div>
        `;
        card.addEventListener('click', () => openWatch(video.id));
        list.appendChild(card);
      });
    }

    function construirTrilhas() {
      const trilhas = [];
      const categoriasOrdenadas = Object.entries(state.afinidade.categorias || {})
        .sort((a, b) => b[1] - a[1])
        .map(([categoria]) => categoria)
        .slice(0, 3);
      categoriasOrdenadas.forEach(cat => {
        const vids = state.videos.filter(v => v.category === cat).slice(0, 8);
        if (vids.length) {
          trilhas.push({ titulo: `${cat} em alta`, itens: vids });
        }
      });
      const longos = state.videos.filter(v => (v.duration || 0) >= 8).slice(0, 8);
      if (longos.length) trilhas.push({ titulo: 'Para maratonar', itens: longos });
      const recentesHist = getHistoricoVideos().slice(0, 8);
      if (recentesHist.length) trilhas.push({ titulo: 'Baseado no seu histórico', itens: recentesHist });
      return trilhas;
    }

    function renderTracks() {
      const box = qs('#tracks-box');
      const row = qs('#tracks-row');
      if (!box || !row) return;
      if (state.search.termo) { box.classList.add('hidden'); return; }
      const trilhas = construirTrilhas();
      if (!trilhas.length) { box.classList.add('hidden'); return; }
      box.classList.remove('hidden');
      row.innerHTML = '';
      trilhas.forEach(trilha => {
        const card = document.createElement('div');
        card.className = 'track-card';
        card.innerHTML = `
          <h4>${escapeHTML(trilha.titulo)}</h4>
          <div class="track-meta">${trilha.itens.length} vídeo(s) · ${trilha.itens[0]?.category || ''}</div>
          <p style="color:var(--muted);margin:6px 0 0;">Clique para abrir o primeiro e ver a trilha completa.</p>
        `;
        card.addEventListener('click', () => {
          if (trilha.itens[0]) openWatch(trilha.itens[0].id);
        });
        row.appendChild(card);
      });
    }

    function calcularRelevancia(video, termo = '') {
      const search = (termo || '').toLowerCase();
      let score = 0;
      if (search) {
        const t = (video.title || '').toLowerCase();
        const d = (video.description || '').toLowerCase();
        const c = (video.category || '').toLowerCase();
        if (t.includes(search)) score += 8;
        if (d.includes(search)) score += 5;
        if (c.includes(search)) score += 3;
      }
      const afinidade = state.filter.afinidade ? pontuarAfinidade(video) * 2 : 0;
      if (state.filter.ordem === 'recentes') score += (video.createdAt || 0) / 1e10;
      if (state.filter.ordem === 'views') score += (video.views || 0) / 800;
      if (state.filter.ordem === 'avaliados') score += ((video.likes || 0) - (video.dislikes || 0)) / 8;
      score += (video.views || 0) * 0.001;
      score += Math.max(0, (video.likes || 0) - (video.dislikes || 0)) * 0.05;
      score += afinidade;
      return score;
    }

    function aplicarFiltros(lista, opts = {}) {
      const termoBusca = (opts.searchTerm ?? state.search.termo ?? '').toLowerCase();
      let filtrados = [...lista];
      if (state.filter.categoria !== 'all') {
        filtrados = filtrados.filter(v => v.category === state.filter.categoria);
      }
      if (state.filter.duracao !== 'todas') {
        filtrados = filtrados.filter(v => {
          const dur = Number(v.duration) || 0;
          if (state.filter.duracao === 'curtas') return dur <= 4;
          if (state.filter.duracao === 'medias') return dur >= 5 && dur <= 10;
          if (state.filter.duracao === 'longas') return dur > 10;
          return true;
        });
      }
      const decorados = filtrados.map(v => ({ video: v, score: calcularRelevancia(v, termoBusca) }));
      decorados.sort((a, b) => b.score - a.score || (b.video.createdAt || 0) - (a.video.createdAt || 0));
      return decorados.map(d => d.video);
    }

    function atualizarPainelBusca() {
      const box = qs('#search-results-box');
      const resumo = qs('#search-summary');
      const detalhe = qs('#search-detail');
      const lista = qs('#search-results-list');
      if (!box || !resumo || !lista) return;
      if (!state.search.termo) {
        box.classList.add('hidden');
        lista.innerHTML = '';
        return;
      }
      box.classList.remove('hidden');
      const total = state.search.resultados.length;
      resumo.textContent = total ? `Resultados para "${state.search.termo}" (${total})` : `Nenhum resultado para "${state.search.termo}"`;
      detalhe.textContent = total ? 'Use os botões para navegar ou clique em um item abaixo.' : 'Tente outro termo ou limpe a busca para voltar ao feed completo.';
      lista.innerHTML = '';
      state.search.resultados.forEach((video, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'search-chip' + (idx === state.search.indice ? ' active' : '');
        btn.textContent = video.title;
        btn.addEventListener('click', () => {
          state.search.indice = idx;
          atualizarPainelBusca();
          openWatch(video.id);
        });
        lista.appendChild(btn);
      });
    }

    function atualizarPaginacao(total, totalPages, pageItems) {
      const resumo = qs('#grid-summary');
      const prev = qs('#grid-prev');
      const next = qs('#grid-next');
      const paginaAtual = state.pagination.page;
      const inicio = total ? (pageItems.length ? (pageItems[0].indexRef + 1) : 0) : 0;
      const fim = total ? (pageItems.length ? (pageItems[pageItems.length - 1].indexRef + 1) : 0) : 0;
      if (resumo) {
        resumo.textContent = total ? `Exibindo ${inicio}–${fim} de ${total} vídeo(s)` : 'Nenhum vídeo encontrado para os filtros atuais.';
      }
      if (prev) prev.disabled = paginaAtual <= 1 || totalPages <= 1;
      if (next) next.disabled = paginaAtual >= totalPages || totalPages <= 1;
    }

    function renderGrid() {
      const grid = qs('#video-grid');
      if (!grid) return;
      renderGridSkeleton();

      const termoBusca = state.search.termo;
      const baseLista = termoBusca ? state.search.resultados : state.videos;
      const videosFiltrados = aplicarFiltros(baseLista, { searchTerm: termoBusca });
      renderRecommendations();
      renderTracks();
      const total = videosFiltrados.length;
      const totalPages = Math.max(1, Math.ceil(total / state.pagination.perPage));
      state.pagination.page = Math.min(state.pagination.page, totalPages);
      const start = (state.pagination.page - 1) * state.pagination.perPage;
      const end = start + state.pagination.perPage;

      const pageItems = videosFiltrados.slice(start, end).map((v, idx) => ({ ...v, indexRef: start + idx }));
      grid.innerHTML = '';

      if (!total) {
        grid.innerHTML = '<p style="color: var(--muted);">Nenhum vídeo encontrado para os filtros atuais. Ajuste a busca ou as opções de categoria/ordem/duração.</p>';
        atualizarPaginacao(0, 1, []);
        return;
      }

      pageItems.forEach(video => {
        const card = document.createElement('div');
        const inWatchLater = state.watchLater.includes(video.id);
        const inPlaylist = state.playlists.includes(video.id);
        const inHistory = state.historico.includes(video.id);
        card.className = 'video-card';
        card.dataset.id = video.id;
        const titulo = termoBusca ? highlightTerm(video.title, termoBusca) : escapeHTML(video.title);
        const metaTexto = `${video.channel} · ${video.views} visualizações · ${timeAgo(video.createdAt)}`;
        const meta = termoBusca ? highlightTerm(metaTexto, termoBusca) : escapeHTML(metaTexto);
        card.innerHTML = `
          <div class="thumb">
            <img src="${video.thumb}" alt="Thumbnail" loading="lazy" decoding="async">
            <div class="badge">${minutesToDuration(video.duration)}</div>
          </div>
          <div class="card-body">
            <div class="avatar">${video.channel.charAt(0).toUpperCase()}</div>
            <div class="card-text">
              <h4>${titulo}</h4>
              <p>${meta}</p>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="pill-btn ghost watchlater-btn" data-id="${video.id}" aria-pressed="${inWatchLater}">${inWatchLater ? 'Remover' : 'Assistir depois'}</button>
            <button class="pill-btn ghost offline-btn" data-id="${video.id}">Salvar offline</button>
            <button class="pill-btn ghost playlist-btn" data-id="${video.id}" aria-pressed="${inPlaylist}">${inPlaylist ? 'Na playlist' : 'Adicionar à playlist'}</button>
            <button class="pill-btn ghost history-btn" data-id="${video.id}" aria-pressed="${inHistory}">${inHistory ? 'No histórico' : 'Salvar histórico'}</button>
          </div>
        `;
        card.addEventListener('click', () => openWatch(video.id));
        card.querySelector('.watchlater-btn').addEventListener('click', (ev) => {
          ev.stopPropagation();
          toggleWatchLater(video.id);
        });
        card.querySelector('.offline-btn').addEventListener('click', (ev) => {
          ev.stopPropagation();
          saveOffline(video.id);
        });
        card.querySelector('.playlist-btn').addEventListener('click', (ev) => {
          ev.stopPropagation();
          addToPlaylist(video.id);
        });
        card.querySelector('.history-btn').addEventListener('click', (ev) => {
          ev.stopPropagation();
          addToHistory(video.id, false);
        });
        grid.appendChild(card);
      });

      atualizarPaginacao(total, totalPages, pageItems);
      const categories = qs('#categories');
      categories.classList.toggle('hidden', state.videos.length === 0);
    }

    function navegarPagina(delta) {
      const baseLista = state.search.termo ? state.search.resultados : state.videos;
      const total = aplicarFiltros(baseLista).length;
      const totalPages = Math.max(1, Math.ceil(total / state.pagination.perPage));
      state.pagination.page = Math.min(Math.max(1, state.pagination.page + delta), totalPages);
      renderGrid();
    }

    const renderGridDebounced = debounce(renderGrid, 250);
    const executarBuscaDebounced = debounce(() => executarBusca(true), 250);
    const executarBuscaDebouncedComFeedback = debounce(() => executarBusca(false), 250);

    function renderClips() {
      const grid = qs('#clips-grid');
      grid.innerHTML = '';
      state.clips.forEach(clip => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <div class="thumb">
            <img src="${clip.thumb}" alt="Thumbnail clip">
            <div class="badge">${clip.duration}</div>
          </div>
          <div class="card-body">
            <div class="avatar">C</div>
            <div class="card-text">
              <h4>${clip.title}</h4>
              <p>${clip.views} visualizações${clip.status ? ' · ' + clip.status : ''}</p>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function getWatchLaterVideos() {
      return state.watchLater
        .map(id => state.videos.find(v => v.id === id))
        .filter(Boolean);
    }

    function getPlaylistVideos() {
      return state.playlists
        .map(id => state.videos.find(v => v.id === id))
        .filter(Boolean);
    }

    function getHistoricoVideos() {
      return state.historico
        .map(id => state.videos.find(v => v.id === id))
        .filter(Boolean);
    }

    function aplicarFiltrosWatchLater(lista) {
      let filtrados = [...lista];
      if (state.watchLaterFilter.categoria !== 'all') {
        filtrados = filtrados.filter(v => v.category === state.watchLaterFilter.categoria);
      }
      if (state.watchLaterFilter.ordem === 'recentes') {
        filtrados.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      } else if (state.watchLaterFilter.ordem === 'views') {
        filtrados.sort((a, b) => (b.views || 0) - (a.views || 0));
      } else if (state.watchLaterFilter.ordem === 'avaliados') {
        filtrados.sort((a, b) => ((b.likes || 0) - (b.dislikes || 0)) - ((a.likes || 0) - (a.dislikes || 0)));
      }
      return filtrados;
    }

    function renderWatchLater() {
      const grid = qs('#watchlater-grid');
      if (!grid) return;
      grid.innerHTML = '';
      const filtrados = aplicarFiltrosWatchLater(getWatchLaterVideos());
      if (!filtrados.length) {
        grid.innerHTML = '<p style="color: var(--muted);">Nada salvo em "Assistir depois". Clique no botão nos cards ou no player para adicionar.</p>';
        return;
      }
      filtrados.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.dataset.id = video.id;
        card.innerHTML = `
          <div class="thumb">
            <img src="${video.thumb}" alt="Thumbnail">
            <div class="badge">${minutesToDuration(video.duration)}</div>
          </div>
          <div class="card-body">
            <div class="avatar">${video.channel.charAt(0).toUpperCase()}</div>
            <div class="card-text">
              <h4>${video.title}</h4>
              <p>${video.channel} · ${video.views} visualizações · ${timeAgo(video.createdAt)}</p>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="pill-btn ghost" data-action="open" data-id="${video.id}">Assistir agora</button>
            <button class="pill-btn ghost" data-action="remove" data-id="${video.id}">Remover</button>
          </div>
        `;
        card.addEventListener('click', () => openWatch(video.id));
        card.querySelector('[data-action="open"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          openWatch(video.id);
        });
        card.querySelector('[data-action="remove"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          toggleWatchLater(video.id);
        });
        grid.appendChild(card);
      });
    }

    function renderPlaylists() {
      const grid = qs('#playlist-grid');
      if (!grid) return;
      grid.innerHTML = '';
      const filtrados = aplicarFiltrosWatchLater(getPlaylistVideos());
      if (!filtrados.length) {
        grid.innerHTML = '<p style="color: var(--muted);">Nenhum item na playlist. Use os botões dos cards ou do player para adicionar.</p>';
        return;
      }
      filtrados.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.dataset.id = video.id;
        card.innerHTML = `
          <div class="thumb">
            <img src="${video.thumb}" alt="Thumbnail playlist">
            <div class="badge">${minutesToDuration(video.duration)}</div>
          </div>
          <div class="card-body">
            <div class="avatar">${video.channel.charAt(0).toUpperCase()}</div>
            <div class="card-text">
              <h4>${video.title}</h4>
              <p>${video.channel} · ${video.views} visualizações · ${timeAgo(video.createdAt)}</p>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="pill-btn ghost" data-action="open" data-id="${video.id}">Assistir</button>
            <button class="pill-btn ghost" data-action="remove" data-id="${video.id}">Remover</button>
          </div>
        `;
        card.addEventListener('click', () => openWatch(video.id));
        card.querySelector('[data-action="open"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          openWatch(video.id);
        });
        card.querySelector('[data-action="remove"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          removeFromPlaylist(video.id);
        });
        grid.appendChild(card);
      });
    }

    function renderHistorico() {
      const grid = qs('#history-grid');
      if (!grid) return;
      grid.innerHTML = '';
      const filtrados = aplicarFiltrosWatchLater(getHistoricoVideos());
      if (!filtrados.length) {
        grid.innerHTML = '<p style="color: var(--muted);">Seu histórico está vazio. Ao assistir um vídeo ele aparece aqui.</p>';
        return;
      }
      filtrados.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.dataset.id = video.id;
        card.innerHTML = `
          <div class="thumb">
            <img src="${video.thumb}" alt="Thumbnail histórico">
            <div class="badge">${minutesToDuration(video.duration)}</div>
          </div>
          <div class="card-body">
            <div class="avatar">${video.channel.charAt(0).toUpperCase()}</div>
            <div class="card-text">
              <h4>${video.title}</h4>
              <p>${video.channel} · ${video.views} visualizações · ${timeAgo(video.createdAt)}</p>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="pill-btn ghost" data-action="open" data-id="${video.id}">Rever</button>
            <button class="pill-btn ghost" data-action="remove" data-id="${video.id}">Remover</button>
          </div>
        `;
        card.addEventListener('click', () => openWatch(video.id));
        card.querySelector('[data-action="open"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          openWatch(video.id);
        });
        card.querySelector('[data-action="remove"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          state.historico = state.historico.filter(id => id !== video.id);
          persistHistorico();
          renderHistorico();
        });
        grid.appendChild(card);
      });
    }

    function ativarAbaBiblioteca(tab) {
      const clipsGrid = qs('#clips-grid');
      const watchLaterGrid = qs('#watchlater-grid');
      const playlistGrid = qs('#playlist-grid');
      const historyGrid = qs('#history-grid');
      const filters = qs('#watchlater-filters');
      const tabClips = qs('#tab-clips');
      const tabWatch = qs('#tab-watchlater');
      const tabPlay = qs('#tab-playlists');
      const tabHist = qs('#tab-history');
      if (!clipsGrid || !watchLaterGrid || !tabClips || !tabWatch || !playlistGrid || !historyGrid || !tabPlay || !tabHist) return;
      const tabs = ['clips', 'watchlater', 'playlists', 'history'];
      const elements = { clips: tabClips, watchlater: tabWatch, playlists: tabPlay, history: tabHist };
      const grids = { clips: clipsGrid, watchlater: watchLaterGrid, playlists: playlistGrid, history: historyGrid };
      tabs.forEach(name => {
        const isActive = tab === name;
        elements[name].classList.toggle('active', isActive);
        elements[name].setAttribute('aria-pressed', String(isActive));
        grids[name].classList.toggle('hidden', !isActive);
      });
      filters?.classList.toggle('hidden', tab === 'clips');
      if (tab === 'watchlater') renderWatchLater();
      if (tab === 'playlists') renderPlaylists();
      if (tab === 'history') renderHistorico();
    }

    function renderSuggestions(currentId) {
      const box = qs('#suggestions');
      box.innerHTML = '';
      state.videos.filter(v => v.id !== currentId).slice(0,6).forEach(video => {
        const item = document.createElement('div');
        item.className = 'video-card';
        item.style.gridTemplateColumns = '120px 1fr';
        item.innerHTML = `
          <div class="thumb" style="aspect-ratio:16/9;">
            <img src="${video.thumb}" alt="Thumb sugerido">
            <div class="badge">${minutesToDuration(video.duration)}</div>
          </div>
          <div class="card-body" style="grid-template-columns:1fr;">
            <div class="card-text">
              <h4>${video.title}</h4>
              <p>${video.channel} · ${video.views} visualizações</p>
            </div>
          </div>
        `;
        item.addEventListener('click', () => openWatch(video.id));
        box.appendChild(item);
      });
    }

    function limparBusca() {
      state.search = { termo: '', resultados: [], indice: 0 };
      qs('#search').value = '';
      atualizarPainelBusca();
      resetPagination();
      renderGrid();
    }

    function executarBusca(silencioso = false) {
      const termo = qs('#search').value.trim().toLowerCase();
      if (!termo) {
        limparBusca();
        return;
      }
      const resultados = state.videos
        .filter(v =>
          v.title.toLowerCase().includes(termo) ||
          v.description.toLowerCase().includes(termo) ||
          v.channel.toLowerCase().includes(termo) ||
          v.category.toLowerCase().includes(termo)
        )
        .map(v => ({ video: v, score: calcularRelevancia(v, termo) }))
        .sort((a, b) => b.score - a.score)
        .map(item => item.video);
      state.search = { termo, resultados, indice: 0 };
      atualizarPainelBusca();
      resetPagination();
      renderGrid();
      if (!silencioso) {
        showToast(resultados.length ? `${resultados.length} resultado(s) encontrados.` : 'Nenhum vídeo encontrado.');
      }
    }

    function navegarResultado(delta) {
      if (!state.search.resultados.length) return;
      const total = state.search.resultados.length;
      state.search.indice = (state.search.indice + delta + total) % total;
      atualizarPainelBusca();
      const atual = state.search.resultados[state.search.indice];
      if (atual) openWatch(atual.id);
    }

    function openWatch(id) {
      const video = state.videos.find(v => v.id === id);
      if (!video) return;
      state.currentVideo = video;
      video.views += 1;
      persistSharedState();
      qs('#watch-title').textContent = video.title;
      qs('#watch-desc').textContent = video.description;
      qs('#watch-stats').textContent = `${video.channel} · ${video.views} visualizações · ${timeAgo(video.createdAt)}`;
      qs('#like-count').textContent = video.likes || 0;
      qs('#dislike-count').textContent = video.dislikes || 0;
      qs('#player-thumb').style.background = `center / cover url(${video.thumb})`;
      addToHistory(video.id, true);
      state.transcriptSearch = '';
      state.player = { duration: Math.max(1, Math.round((video.duration || 1) * 60)), position: 0, playing: false, volume: state.player?.volume ?? 0.8 };
      const transcriptInput = qs('#transcript-search');
      if (transcriptInput) transcriptInput.value = '';
      showSection('watch');
      renderSuggestions(id);
      renderComments(id);
      atualizarEstadoWatchButtons(id);
      renderChapters(video);
      renderTranscript(video);
      syncPlayerStatus();
    }

    function atualizarEstadoWatchButtons(videoId) {
      const wl = qs('#action-watchlater');
      const off = qs('#action-offline');
      const pl = qs('#action-playlist');
      const hist = qs('#action-history');
      const inList = state.watchLater.includes(videoId);
      if (wl) {
        wl.textContent = inList ? 'Remover da lista' : 'Assistir depois';
        wl.setAttribute('aria-pressed', String(inList));
      }
      if (off) {
        const offline = state.clips.some(c => c.offlineFrom === videoId || c.id === `offline-${videoId}`);
        off.textContent = offline ? 'Offline disponível' : 'Salvar offline';
        off.disabled = offline;
        off.setAttribute('aria-disabled', String(offline));
      }
      const inPlaylist = state.playlists.includes(videoId);
      if (pl) {
        pl.textContent = inPlaylist ? 'Na playlist' : 'Adicionar à playlist';
        pl.setAttribute('aria-pressed', String(inPlaylist));
      }
      const inHistory = state.historico.includes(videoId);
      if (hist) {
        hist.textContent = inHistory ? 'No histórico' : 'Salvar histórico';
        hist.setAttribute('aria-pressed', String(inHistory));
      }
    }

    function likeVideo(delta) {
      if (!state.currentVideo) return;
      const vid = state.currentVideo;
      vid.likes = (vid.likes || 0) + (delta === 'up' ? 1 : 0);
      vid.dislikes = (vid.dislikes || 0) + (delta === 'down' ? 1 : 0);
      persistSharedState();
      qs('#like-count').textContent = vid.likes;
      qs('#dislike-count').textContent = vid.dislikes;
    }

    // Navegação
    function showView(view) {
      qs('#login-view').classList.add('hidden');
      qs('#signup-view').classList.add('hidden');
      qs('#app').classList.add('hidden');
      if (view === 'login') qs('#login-view').classList.remove('hidden');
      if (view === 'signup') qs('#signup-view').classList.remove('hidden');
      if (view === 'app') qs('#app').classList.remove('hidden');
    }

    function showSection(section) {
      qs('#home-view').classList.add('hidden');
      qs('#watch-view').classList.add('hidden');
      qs('#clips-view').classList.add('hidden');
      if (section === 'home') qs('#home-view').classList.remove('hidden');
      if (section === 'watch') {
        qs('#watch-view').classList.remove('hidden');
        bindPlayerShortcuts();
      }
      if (section === 'clips') {
        qs('#clips-view').classList.remove('hidden');
        ativarAbaBiblioteca('clips');
      }
      qsa('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.view === section));
      if (section !== 'watch') unbindPlayerShortcuts();
    }

    // Upload
    function renderThumbGallery() {
      const gallery = qs('#thumb-gallery');
      gallery.innerHTML = '';
      defaultThumbs.forEach((src, idx) => {
        const opt = document.createElement('label');
        opt.className = 'thumb-option';
        opt.innerHTML = `<img src="${src}" alt="Thumb ${idx+1}"><input type="radio" name="thumb" value="${src}" ${idx===0?'checked':''}>`;
        gallery.appendChild(opt);
      });
    }

    function openUpload() { qs('#upload-modal').style.display = 'flex'; }
    function closeUpload() { qs('#upload-modal').style.display = 'none'; }

    function handleUpload(e) {
      e.preventDefault();
      const title = qs('#video-title').value.trim();
      const description = qs('#video-desc').value.trim();
      const duration = Number(qs('#video-duration').value) || 1;
      const category = qs('#video-category').value;
      const thumb = (qs('input[name="thumb"]:checked')?.value) || defaultThumbs[0];
      if (!title || !description) return showToast('Preencha título e descrição.');
      const video = {
        id: 'v-' + crypto.randomUUID(),
        title,
        description,
        duration,
        category,
        thumb,
        channel: state.user?.display || state.user?.username || 'Criador',
        views: 0,
        likes: 0,
        dislikes: 0,
        createdAt: Date.now(),
      };
      state.videos.unshift(video);
      persistSharedState();
      atualizarAfinidade();
      renderGrid();
      closeUpload();
      showToast('Vídeo publicado e adicionado ao feed.');
    }

      // Autenticação
      const SESSION_EXPIRED_MESSAGE = 'Sessão expirada. Faça login novamente.';

      function persistSession(session) {
        state.session = session;
        storage.save('mtube-session', session);
      }

      function limparSessao() {
        persistSession(null);
        state.user = null;
      }

      function sessaoValida(session) {
        return !!(session && session.username && session.expiresAt && session.expiresAt > Date.now());
      }

      async function handleSignup(ev) {
        ev.preventDefault();
        const username = qs('#signup-username').value.trim();
        const password = qs('#signup-password').value;
        const display = qs('#signup-display').value.trim() || username;
        if (state.users.find(u => u.username === username)) return showToast('Usuário já existe.');
        const hash = await sha256(password);
        const user = { username, password: hash, display };
        state.users.push(user);
        persistSharedState();
        showToast('Conta criada. Faça login.');
        showView('login');
      }

    async function handleLogin(ev) {
      ev.preventDefault();
      const username = qs('#login-username').value.trim();
        const password = qs('#login-password').value;
        const hash = await sha256(password);
        const found = state.users.find(u => u.username === username && u.password === hash);
        if (!found) return showToast('Usuário ou senha inválidos.');
        state.user = found;
        if (qs('#remember').checked) {
          persistSession({ username, expiresAt: Date.now() + SESSION_TTL_MS });
        } else {
          persistSession(null);
        }
        qs('#user-name').textContent = found.display || found.username;
        showView('app');
        showSection('home');
        renderGrid();
        renderClips();
    }

      function logout() {
        limparSessao();
        showView('login');
      }

      function tryAutoLogin() {
        if (!sessaoValida(state.session)) {
          if (state.session) showToast(SESSION_EXPIRED_MESSAGE);
          limparSessao();
          showView('login');
          return;
        }
        const found = state.users.find(u => u.username === state.session.username);
        if (!found) {
          limparSessao();
          showView('login');
          return;
        }
        state.user = found;
        qs('#user-name').textContent = found.display || found.username;
        showView('app');
        showSection('home');
        renderGrid();
        renderClips();
      }

    // Eventos
    function bindEvents() {
      qs('#go-signup').addEventListener('click', () => showView('signup'));
      qs('#back-login').addEventListener('click', () => showView('login'));
      qs('#signup-form').addEventListener('submit', handleSignup);
      qs('#login-form').addEventListener('submit', handleLogin);
      qsa('.nav-item').forEach(item => item.addEventListener('click', () => {
        const view = item.dataset.view;
        if (view === 'upload') return openUpload();
        showSection(view === 'home' ? 'home' : view);
      }));
      qs('#nav-logout').addEventListener('click', logout);
      qs('#open-upload').addEventListener('click', openUpload);
      qs('#from-hero-upload').addEventListener('click', openUpload);
      qs('#cancel-upload').addEventListener('click', closeUpload);
      qs('#upload-form').addEventListener('submit', handleUpload);
      qs('#search-btn').addEventListener('click', () => executarBuscaDebouncedComFeedback());
      const searchInput = qs('#search');
      searchInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') executarBusca(); });
      searchInput.addEventListener('input', () => executarBuscaDebounced());
      qsa('.filter-pill').forEach(pill => pill.addEventListener('click', () => {
        qsa('.filter-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        state.filter.categoria = pill.dataset.filter;
        resetPagination();
        renderGridDebounced();
      }));
      const ordemSelect = qs('#order-select');
      const duracaoSelect = qs('#duration-select');
      ordemSelect.addEventListener('change', () => { state.filter.ordem = ordemSelect.value; resetPagination(); renderGridDebounced(); });
      duracaoSelect.addEventListener('change', () => { state.filter.duracao = duracaoSelect.value; resetPagination(); renderGridDebounced(); });
      qs('#prev-result').addEventListener('click', () => navegarResultado(-1));
      qs('#next-result').addEventListener('click', () => navegarResultado(1));
      qs('#open-current').addEventListener('click', () => {
        const atual = state.search.resultados[state.search.indice];
        if (atual) openWatch(atual.id);
      });
      qs('#clear-search').addEventListener('click', limparBusca);
      qs('#action-like').addEventListener('click', () => likeVideo('up'));
      qs('#action-dislike').addEventListener('click', () => likeVideo('down'));
      qs('#action-subscribe').addEventListener('click', () => showToast('Inscrição registrada localmente.'));
      qs('#action-watchlater').addEventListener('click', () => {
        if (!state.currentVideo) return showToast('Abra um vídeo primeiro.');
        toggleWatchLater(state.currentVideo.id);
      });
      qs('#action-offline').addEventListener('click', () => {
        if (!state.currentVideo) return showToast('Abra um vídeo primeiro.');
        saveOffline(state.currentVideo.id);
      });
      qs('#action-playlist').addEventListener('click', () => {
        if (!state.currentVideo) return showToast('Abra um vídeo primeiro.');
        addToPlaylist(state.currentVideo.id);
      });
      qs('#action-history').addEventListener('click', () => {
        if (!state.currentVideo) return showToast('Abra um vídeo primeiro.');
        addToHistory(state.currentVideo.id, false);
      });
      const commentForm = qs('#comment-form');
      if (commentForm) commentForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        if (!state.currentVideo) return showToast('Abra um vídeo para comentar.');
        const text = qs('#comment-text').value;
        addComment(state.currentVideo.id, text);
        qs('#comment-text').value = '';
      });
      const commentList = qs('#comments-list');
      if (commentList) commentList.addEventListener('click', (ev) => {
        const btn = ev.target.closest('[data-comment-action]');
        if (!btn) return;
        if (btn.dataset.commentAction === 'report') {
          reportComment(btn.dataset.id);
        } else {
          reactToComment(btn.dataset.id, btn.dataset.commentAction);
        }
      });
      const transcriptSearch = qs('#transcript-search');
      transcriptSearch?.addEventListener('input', debounce(() => {
        state.transcriptSearch = transcriptSearch.value.trim();
        if (state.currentVideo) renderTranscript(state.currentVideo);
      }, 200));
      const tabClips = qs('#tab-clips');
      const tabWatch = qs('#tab-watchlater');
      const tabPlay = qs('#tab-playlists');
      const tabHist = qs('#tab-history');
      tabClips?.addEventListener('click', () => ativarAbaBiblioteca('clips'));
      tabWatch?.addEventListener('click', () => ativarAbaBiblioteca('watchlater'));
      tabPlay?.addEventListener('click', () => ativarAbaBiblioteca('playlists'));
      tabHist?.addEventListener('click', () => ativarAbaBiblioteca('history'));
      const wlOrder = qs('#wl-order');
      const wlCat = qs('#wl-category');
      wlOrder?.addEventListener('change', () => {
        state.watchLaterFilter.ordem = wlOrder.value;
        renderWatchLater();
        renderPlaylists();
        renderHistorico();
      });
      wlCat?.addEventListener('change', () => {
        state.watchLaterFilter.categoria = wlCat.value;
        renderWatchLater();
        renderPlaylists();
        renderHistorico();
      });
      qs('#grid-prev')?.addEventListener('click', () => navegarPagina(-1));
      qs('#grid-next')?.addEventListener('click', () => navegarPagina(1));
    }

    // Bootstrap
    ensureSeedVideos();
    atualizarAfinidade();
    renderThumbGallery();
    bindEvents();
    tryAutoLogin();
    atualizarPainelBusca();
    renderGrid();
    renderClips();
    renderWatchLater();
    renderPlaylists();
    renderHistorico();
    if (!state.user) showView('login');
  </script>
</body>
</html>
